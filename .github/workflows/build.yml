$ chmod +x update_workflow.sh && ./update_workflow.sh

======================================
 Textream ä¸­æ–‡ç‰ˆ - Workflow æ›´æ–°æŒ‡å—
======================================

ğŸ“ è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

1ï¸âƒ£  åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ç¼–è¾‘é¡µé¢ï¼š
   https://github.com/Wjzhong123/textream-cn/edit/master/.github/workflows/build.yml

2ï¸âƒ£  å…¨é€‰æ—§å†…å®¹ï¼ˆCmd+A æˆ– Ctrl+Aï¼‰å¹¶åˆ é™¤

3ï¸âƒ£  å¤åˆ¶ä¸‹é¢è™šçº¿ä¹‹é—´çš„å†…å®¹ï¼š

============================================================
name: Build Textreamä¸­æ–‡ç‰ˆ

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·'
        required: false
        default: 'v1.5.1-cn'

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
      run: |
        echo "=== ç¯å¢ƒä¿¡æ¯ ==="
        xcodebuild -version
        sw_vers
        pwd
        ls -la

    - name: ç¼–è¯‘Apple Siliconç‰ˆæœ¬
      run: |
        cd Textream
        echo "=== å¼€å§‹ç¼–è¯‘ Apple Silicon ç‰ˆæœ¬ ==="
        xcodebuild archive \
          -project Textream.xcodeproj \
          -scheme Textream \
          -configuration Release \
          -archivePath ../build-arm.xcarchive \
          -destination "generic/platform=macOS" \
          ARCHS=arm64 ONLY_ACTIVE_ARCH=NO SKIP_INSTALL=NO
        echo "=== Apple Silicon ç¼–è¯‘å®Œæˆ ==="
        ls -la ../build-arm.xcarchive/Products/Applications/

    - name: ç¼–è¯‘Intelç‰ˆæœ¬
      run: |
        cd Textream
        echo "=== å¼€å§‹ç¼–è¯‘ Intel ç‰ˆæœ¬ ==="
        xcodebuild archive \
          -project Textream.xcodeproj \
          -scheme Textream \
          -configuration Release \
          -archivePath ../build-x86.xcarchive \
          -destination "generic/platform=macOS" \
          ARCHS=x86_64 ONLY_ACTIVE_ARCH=NO SKIP_INSTALL=NO
        echo "=== Intel ç¼–è¯‘å®Œæˆ ==="
        ls -la ../build-x86.xcarchive/Products/Applications/

    - name: åˆ›å»ºé€šç”¨äºŒè¿›åˆ¶
      run: |
        echo "=== åˆ›å»ºé€šç”¨äºŒè¿›åˆ¶ ==="
        ARM_APP="build-arm.xcarchive/Products/Applications/Textream.app"
        X86_APP="build-x86.xcarchive/Products/Applications/Textream.app"
        OUTPUT_APP="build-universal/Textream.app"

        mkdir -p build-universal
        cp -R "$ARM_APP" "$OUTPUT_APP"

        find "$ARM_APP" -type f | while read -r arm_file; do
          rel="${arm_file#$ARM_APP}"
          x86_file="$X86_APP$rel"
          out_file="$OUTPUT_APP$rel"

          if [ -f "$x86_file" ] && file "$arm_file" | grep -q "Mach-O"; then
            lipo -create "$arm_file" "$x86_file" -output "$out_file" 2>/dev/null || true
          fi
        done

        echo "=== äºŒè¿›åˆ¶ä¿¡æ¯ ==="
        lipo -info "$OUTPUT_APP/Contents/MacOS/Textream"
        ls -lh "$OUTPUT_APP"

    - name: åˆ›å»ºDMG
      run: |
        echo "=== åˆ›å»ºDMG ==="
        mkdir -p build-dmg
        cp -R build-universal/Textream.app build-dmg/
        ln -s /Applications build-dmg/Applications

        hdiutil create \
          -volname "Textreamä¸­æ–‡ç‰ˆ" \
          -srcfolder build-dmg \
          -ov \
          -format UDZO \
          -imagekey zlib-level=9 \
          Textream-CN.dmg

        echo "=== DMGåˆ›å»ºå®Œæˆ ==="
        ls -lh Textream-CN.dmg
        file Textream-CN.dmg

    - name: æ£€æŸ¥DMGæ–‡ä»¶
      run: |
        echo "=== æ£€æŸ¥DMGæ–‡ä»¶ ==="
        if [ -f "Textream-CN.dmg" ]; then
          echo "âœ… DMGæ–‡ä»¶å­˜åœ¨"
          ls -lh Textream-CN.dmg
          du -h Textream-CN.dmg
        else
          echo "âŒ DMGæ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi

    - name: ä¸Šä¼ DMGåˆ°Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Textream-CN-macOS
        path: Textream-CN.dmg
        retention-days: 90
        if-no-files-found: error

    - name: ä¸Šä¼ å®Œæˆæç¤º
      run: echo "âœ… DMGå·²ä¸Šä¼ åˆ°Artifactsï¼è¯·åœ¨Actionsé¡µé¢çš„Artifactséƒ¨åˆ†ä¸‹è½½"
============================================================

4ï¸âƒ£  ç²˜è´´åˆ°ç¼–è¾‘å™¨

5ï¸âƒ£  æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œæäº¤ä¿¡æ¯å¡«å†™ï¼šFix workflow and add debug info

6ï¸âƒ£  ç‚¹å‡» 'Commit changes' æŒ‰é’®

âœ… å®Œæˆåè®¿é—® Actions é¡µé¢è¿è¡Œç¼–è¯‘ï¼š
   https://github.com/Wjzhong123/textream-cn/actions

ğŸ“¦ ç¼–è¯‘æˆåŠŸåï¼Œåœ¨ Artifacts éƒ¨åˆ†ä¸‹è½½ DMG

======================================

